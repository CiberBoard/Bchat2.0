{% extends "base.html" %}
{% block content %}
<div class="chat-container">
    <div class="sidebar">
        <div class="user-info">
            <p>Your Address: <span id="userAddress">{{ address[:10] }}...</span></p>
            <button onclick="location.href='/logout'">Logout</button>
        </div>

        <!-- Навигация в виде вкладок -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('chat')">Chat</div>
            <div class="tab" onclick="switchTab('contacts')">Contacts</div>
            <div class="tab" onclick="switchTab('groups')">Groups</div>
            <div class="tab" onclick="switchTab('profile')">Profile</div>
        </div>

        <!-- Содержимое вкладок -->
        <div id="chat-tab" class="tab-content active">
            <div class="conversations-header">
                <h3>Conversations</h3>
                <button id="newChatBtn" class="header-btn" title="Start New Chat">+</button>
            </div>
            <div class="conversations-list">
                <ul id="conversationsList">
                    <li class="conversation-item" data-address="" data-is-group="false">
                        <em>Select a conversation</em>
                    </li>
                </ul>
            </div>
        </div>

        <div id="contacts-tab" class="tab-content">
            <h3>Contacts</h3>
            <div class="contacts-list" id="contactsList">
                <p id="noContactsMessage">Loading contacts...</p>
            </div>
            <div class="input-area">
                <input type="text" id="contactName" placeholder="Name">
                <input type="text" id="contactAddress" placeholder="Address">
                <button onclick="addContact()">Add</button>
            </div>
        </div>

        <div id="groups-tab" class="tab-content">
            <h3>Groups</h3>
            <div class="groups-list" id="groupsList">
                <p>Loading groups...</p>
            </div>
            <div class="input-area">
                <input type="text" id="groupName" placeholder="Group Name">
                <input type="text" id="groupMembers" placeholder="Addresses">
                <button onclick="createGroup()">Create</button>
            </div>
        </div>

        <div id="profile-tab" class="tab-content">
            <h3>Your Profile</h3>

            <!-- Адрес -->
            <div class="info-item">
                <label for="address">Your Address:</label>
                <div class="input-with-copy">
                    <input type="text" id="address" value="{{ address }}" readonly>
                    <button onclick="copyToClipboard('address', 'addressFeedback')">Copy</button>
                    <span id="addressFeedback" class="copy-feedback"></span>
                </div>
            </div>

            <!-- Ссылка на полную страницу профиля -->
            <div class="info-item">
                <p>For security information and mnemonic phrase, please visit the full profile page.</p>
                <button onclick="location.href='/profile'" style="width: 100%; margin-top: 10px;">View Full Profile</button>
            </div>

            <!-- Дополнительная информация -->
            <div class="info-item">
                <h4>Account Information</h4>
                <div class="security-info">
                    <p><strong>Wallet Status:</strong> <span class="status-active">Active</span></p>
                    <p><strong>Network:</strong> Mainnet</p>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="chat-header">
            Chat with: <span id="currentChatName">-</span>
            <button id="addToContactsBtn" class="header-btn" onclick="addContactFromChat()" disabled title="Add to Contacts">+</button>
            <button id="clearConversationBtn" class="header-btn" onclick="clearConversation()" disabled title="Clear Messages">&#x1F5D1;</button>
        </div>
        <div class="messages" id="messagesContainer">
            <p id="noChatSelectedMessage">Please select a conversation.</p>
        </div>
        <div class="input-area">
            <input type="text" id="messageContent" placeholder="Type a message..." disabled>
            <button onclick="sendMessage()" id="sendButton" disabled>Send</button>
        </div>
    </div>
</div>

<!-- Модальное окно для нового чата -->
<div id="newChatModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Start New Chat</h2>
        <div class="modal-body">
            <div class="input-group">
                <label for="newChatSelect">Select Contact:</label>
                <select id="newChatSelect">
                    <option value="">-- Select a Contact --</option>
                </select>
            </div>
            <div class="input-group">
                <label for="newChatAddress">Or enter Address:</label>
                <input type="text" id="newChatAddress" placeholder="Enter full 64-character address">
            </div>
            <button id="startNewChatBtn">Start Chat</button>
        </div>
    </div>
</div>

<style>
.status-active {
    color: #00c853;
    font-weight: bold;
}

.security-info {
    background-color: #2c2c2c;
    padding: 15px;
    border-radius: 4px;
    border-left: 3px solid #bb86fc;
}

.security-info p {
    margin: 8px 0;
    font-size: 14px;
}
</style>

<script>
    // Функция переключения вкладок
    function switchTab(tabName) {
        // Скрыть все вкладки
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });

        // Убрать активный класс у всех кнопок
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });

        // Показать выбранную вкладку
        document.getElementById(tabName + '-tab').classList.add('active');

        // Сделать активной кнопку вкладки
        event.target.classList.add('active');

        // Загрузить данные для вкладки если нужно
        if (tabName === 'contacts') {
            loadContacts();
        } else if (tabName === 'groups') {
            loadGroups();
        }
    }

    // Функции копирования
    function copyToClipboard(elementId, feedbackId) {
        const element = document.getElementById(elementId);
        const feedback = document.getElementById(feedbackId);

        navigator.clipboard.writeText(element.value).then(() => {
            feedback.textContent = 'Copied!';
            feedback.style.color = 'green';
            setTimeout(() => { feedback.textContent = ''; }, 2000);
        }).catch(err => {
            console.error('Failed to copy: ', err);
            feedback.textContent = 'Failed to copy!';
            feedback.style.color = 'red';
        });
    }

    // Остальные функции JavaScript (оставляем как в оригинале)
    let currentChatAddress = "";
    let currentChatIsGroup = false;
    let currentChatPartnerAddress = "";
    let userAddress = "{{ address }}";
    let lastMessageTimestamp = 0;
    let pollInterval;
    let allContacts = [];

    // --- Функции для работы с диалогами ---
    async function loadConversations() {
        try {
            const response = await fetch('/get_conversations');
            const data = await response.json();
            if (response.ok) {
                const container = document.getElementById('conversationsList');
                container.innerHTML = '';
                if (data.conversations.length === 0) {
                    container.innerHTML = '<li><em>No conversations. Add contacts!</em></li>';
                } else {
                    data.conversations.forEach(conv => {
                        const li = document.createElement('li');
                        li.className = 'conversation-item';
                        li.dataset.address = conv.address;
                        li.dataset.isGroup = conv.is_group;
                        const displayName = conv.name.length > 25 ? conv.name.substring(0, 22) + '...' : conv.name;
                        li.innerHTML = `
                            <div class="status-indicator"></div>
                            <div>${displayName}</div>
                        `;
                        li.onclick = () => selectConversation(conv.address, conv.name, conv.is_group);
                        container.appendChild(li);
                    });
                }
            } else {
                console.error('Failed to load conversations:', data.error);
            }
        } catch (error) {
            console.error('Error loading conversations:', error);
        }
    }

    function selectConversation(address, name, isGroup) {
        currentChatAddress = address;
        currentChatIsGroup = isGroup;
        currentChatPartnerAddress = isGroup ? "" : (address === userAddress ? "" : address);

        document.getElementById('currentChatName').textContent = name;

        document.querySelectorAll('.conversation-item').forEach(item => {
            item.classList.remove('active');
        });

        const selectedItems = document.querySelectorAll(`.conversation-item[data-address="${address}"]`);
        if (selectedItems.length > 0) {
             selectedItems[0].classList.add('active');
        }

        document.getElementById('messageContent').disabled = false;
        document.getElementById('sendButton').disabled = false;
        document.getElementById('noChatSelectedMessage').style.display = 'none';

        const addToContactsBtn = document.getElementById('addToContactsBtn');
        const clearConversationBtn = document.getElementById('clearConversationBtn');
        if (isGroup || !currentChatPartnerAddress || currentChatPartnerAddress === userAddress) {
            addToContactsBtn.disabled = true;
            addToContactsBtn.title = "Cannot add group or yourself";
        } else {
            addToContactsBtn.disabled = false;
            addToContactsBtn.title = "Add to Contacts";
        }
        clearConversationBtn.disabled = false;
        clearConversationBtn.title = "Clear Messages";

        lastMessageTimestamp = 0;
        loadMessagesForConversation(address);
    }

    async function loadContactsForModal() {
        try {
            const response = await fetch('/get_contacts');
            const data = await response.json();
            if (response.ok) {
                allContacts = data.contacts;
                const selectElement = document.getElementById('newChatSelect');
                selectElement.innerHTML = '<option value="">-- Select a Contact --</option>';
                allContacts.forEach(contact => {
                    const option = document.createElement('option');
                    option.value = contact.address;
                    const displayName = contact.name.length > 30 ? contact.name.substring(0, 27) + '...' : contact.name;
                    option.textContent = `${displayName} (${contact.address.substring(0, 10)}...)`;
                    selectElement.appendChild(option);
                });
            } else {
                console.error('Failed to load contacts for modal:', data.error);
                alert('Could not load contacts.');
            }
        } catch (error) {
            console.error('Error loading contacts for modal:', error);
            alert('An error occurred while loading contacts.');
        }
    }

    async function loadMessagesForConversation(chatWithAddress, isNewMessage = false) {
        if (!chatWithAddress) {
             document.getElementById('messagesContainer').innerHTML = '<p id="noChatSelectedMessage">Please select a conversation.</p>';
             return;
        }
        try {
            const response = await fetch(`/get_conversation?with=${encodeURIComponent(chatWithAddress)}`);
            const data = await response.json();
            if (response.ok) {
                const container = document.getElementById('messagesContainer');
                const shouldScroll = isNewMessage || (container.scrollTop + container.clientHeight >= container.scrollHeight - 5);

                container.innerHTML = '';
                if (data.messages.length === 0) {
                    container.innerHTML = '<p><em>No messages yet.</em></p>';
                } else {
                    let maxTimestamp = 0;
                    data.messages.forEach(msg => {
                        if (msg.timestamp > maxTimestamp) {
                            maxTimestamp = msg.timestamp;
                        }

                        const messageDiv = document.createElement('div');
                        messageDiv.className = `message ${msg.is_mine ? 'sent' : 'received'}`;
                        messageDiv.dataset.messageId = msg.id;

                        let imageHtml = '';
                        if (msg.image) {
                             if (msg.image.startsWith('data:image')) {
                                  imageHtml = `<img src="${msg.image}" alt="Image" style="max-width: 200px;">`;
                             } else {
                                  imageHtml = `<img src="${msg.image}" alt="Image" style="max-width: 200px;">`;
                             }
                        }

                        const senderInfo = (msg.is_mine || !currentChatIsGroup) ? '' : `<strong>${msg.sender_name}</strong><br>`;

                        const deleteBtnHtml = msg.is_mine ?
                            `<button class="delete-message-btn" onclick="deleteMessage(${msg.id}, this)" title="Delete">&#x1F5D9;</button>` :
                            '';

                        messageDiv.innerHTML = `
                            <div class="message-content-wrapper">
                                ${senderInfo}
                                <p>${msg.content}</p>
                                ${imageHtml}
                                <small>${new Date(msg.timestamp * 1000).toLocaleString()}</small>
                            </div>
                            ${deleteBtnHtml}
                        `;
                        container.appendChild(messageDiv);
                    });
                    lastMessageTimestamp = maxTimestamp;
                }

                if (shouldScroll) {
                    container.scrollTop = container.scrollHeight;
                }
            } else {
                console.error('Failed to load conversation:', data.error);
                if (!isNewMessage) {
                     document.getElementById('messagesContainer').innerHTML = `<p>Error loading messages: ${data.error}</p>`;
                }
            }
        } catch (error) {
            console.error('Error loading conversation:', error);
            if (!isNewMessage) {
                 document.getElementById('messagesContainer').innerHTML = `<p>Error loading messages.</p>`;
            }
        }
    }

    async function sendMessage() {
        const content = document.getElementById('messageContent').value.trim();
        const recipient = currentChatAddress;
        const isGroup = currentChatIsGroup === true || currentChatIsGroup === 'true';

        if (!recipient || !content) {
            alert('Please select a conversation and enter a message.');
            return;
        }

        const messageType = isGroup ? 'group' : 'direct';
        const groupId = isGroup ? recipient.split(':')[1] : null;

        const payload = {
            recipient: recipient,
            content: content,
            message_type: messageType
        };
        if (groupId) {
            payload.group_id = groupId;
        }

        try {
            const response = await fetch('/send_message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (response.ok) {
                document.getElementById('messageContent').value = '';
                loadMessagesForConversation(recipient, true);
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred.');
        }
    }

    async function addContactFromChat() {
        if (!currentChatPartnerAddress) {
            alert("Cannot add this conversation to contacts.");
            return;
        }

        const payload = {
            contact_address: currentChatPartnerAddress,
        };

        try {
            const response = await fetch('/add_contact_from_chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (response.ok) {
                alert(data.message);
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error adding contact:', error);
            alert('An error occurred while adding the contact.');
        }
    }

    async function deleteMessage(messageId, buttonElement) {
        if (!confirm("Delete this message for yourself?")) {
            return;
        }

        try {
            buttonElement.disabled = true;
            buttonElement.textContent = '...';

            const response = await fetch('/delete_message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message_id: messageId })
            });
            const data = await response.json();
            if (response.ok) {
                buttonElement.closest('.message').remove();
                console.log(data.message);
            } else {
                alert('Error: ' + data.error);
                buttonElement.disabled = false;
                buttonElement.textContent = '&#x1F5D9;';
            }
        } catch (error) {
            console.error('Error deleting message:', error);
            alert('An error occurred while deleting the message.');
            buttonElement.disabled = false;
            buttonElement.textContent = '&#x1F5D9;';
        }
    }

    async function clearConversation() {
        if (!currentChatAddress) {
            alert("No conversation selected.");
            return;
        }

        if (!confirm("Clear all messages in this conversation?")) {
            return;
        }

        try {
            const response = await fetch('/clear_conversation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_with: currentChatAddress })
            });
            const data = await response.json();
            if (response.ok) {
                document.getElementById('messagesContainer').innerHTML = '<p><em>Conversation cleared.</em></p>';
                console.log(data.message);
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error clearing conversation:', error);
            alert('An error occurred while clearing the conversation.');
        }
    }

    // --- Логика нового чата ---
    function openNewChatModal() {
        document.getElementById('newChatModal').style.display = 'block';
        document.getElementById('newChatSelect').value = '';
        document.getElementById('newChatAddress').value = '';
        loadContactsForModal();
    }

    function closeNewChatModal() {
        document.getElementById('newChatModal').style.display = 'none';
    }

    async function startNewChat() {
        const selectedAddress = document.getElementById('newChatSelect').value.trim();
        const enteredAddress = document.getElementById('newChatAddress').value.trim();

        let chatAddress = '';
        let chatName = '';

        if (selectedAddress) {
            chatAddress = selectedAddress;
            const contact = allContacts.find(c => c.address === selectedAddress);
            chatName = contact ? contact.name : selectedAddress.substring(0, 10) + '...';
        } else if (enteredAddress) {
            if (enteredAddress.length !== 64) {
                alert('Please enter a valid 64-character address.');
                return;
            }
            if (enteredAddress === userAddress) {
                alert('You cannot start a chat with yourself.');
                return;
            }
            chatAddress = enteredAddress;
            chatName = enteredAddress.substring(0, 10) + '...';
        } else {
            alert('Please select a contact or enter an address.');
            return;
        }

        closeNewChatModal();
        selectConversation(chatAddress, chatName, false);
    }

    // --- Контакты ---
    async function loadContacts() {
        try {
            const response = await fetch('/get_contacts');
            const data = await response.json();
            if (response.ok) {
                const container = document.getElementById('contactsList');
                const noContactsMsg = document.getElementById('noContactsMessage');
                container.innerHTML = '';
                if (data.contacts.length === 0) {
                    noContactsMsg.style.display = 'block';
                    noContactsMsg.textContent = 'No contacts found. Add one!';
                } else {
                    noContactsMsg.style.display = 'none';
                    const ul = document.createElement('ul');
                    data.contacts.forEach(contact => {
                        const li = document.createElement('li');
                        li.className = 'contact-item';
                        li.innerHTML = `
                            <span class="contact-info">${contact.name} (${contact.address.substring(0, 10)}...)</span>
                            <button class="delete-btn" onclick="deleteContact('${contact.address}', this)">Delete</button>
                        `;
                        ul.appendChild(li);
                    });
                    container.appendChild(ul);
                }
            } else {
                console.error('Failed to load contacts:', data.error);
                document.getElementById('contactsList').innerHTML = `<p class="error">Error loading contacts: ${data.error}</p>`;
            }
        } catch (error) {
            console.error('Error loading contacts:', error);
            document.getElementById('contactsList').innerHTML = `<p class="error">Error loading contacts.</p>`;
        }
    }

    async function addContact() {
        const name = document.getElementById('contactName').value.trim();
        const address = document.getElementById('contactAddress').value.trim();

        if (!name || !address) {
            alert('Please fill in both name and address.');
            return;
        }

        if (address.length !== 64) {
            alert('Invalid address format. Address must be 64 characters long.');
            return;
        }

        try {
            const response = await fetch('/add_contact', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, address })
            });
            const data = await response.json();
            if (response.ok) {
                document.getElementById('contactName').value = '';
                document.getElementById('contactAddress').value = '';
                loadContacts();
                alert('Contact added successfully.');
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while adding the contact.');
        }
    }

    async function deleteContact(address, buttonElement) {
        if (!confirm("Are you sure you want to delete this contact?")) {
            return;
        }

        try {
            buttonElement.disabled = true;
            buttonElement.textContent = 'Deleting...';

            const response = await fetch('/delete_contact', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ address })
            });
            const data = await response.json();
            if (response.ok) {
                buttonElement.closest('li').remove();
                const contactItems = document.querySelectorAll('.contact-item');
                if (contactItems.length === 0) {
                    document.getElementById('noContactsMessage').style.display = 'block';
                    document.getElementById('noContactsMessage').textContent = 'No contacts found. Add one!';
                }
                alert('Contact deleted successfully.');
            } else if (response.status === 404) {
                alert('Contact not found.');
                buttonElement.closest('li').remove();
            } else {
                alert('Error: ' + data.error);
                buttonElement.disabled = false;
                buttonElement.textContent = 'Delete';
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while deleting the contact.');
            buttonElement.disabled = false;
            buttonElement.textContent = 'Delete';
        }
    }

    // --- Группы ---
    async function loadGroups() {
        try {
            const response = await fetch('/get_groups');
            const data = await response.json();
            if (response.ok) {
                const container = document.getElementById('groupsList');
                container.innerHTML = '<ul>';
                if (data.groups.length === 0) {
                    container.innerHTML += '<li>No groups found.</li>';
                } else {
                    data.groups.forEach(group => {
                        container.innerHTML += `<li>${group.name} (ID: ${group.id.substring(0, 10)}...)</li>`;
                    });
                }
                container.innerHTML += '</ul>';
            } else {
                console.error('Failed to load groups:', data.error);
                document.getElementById('groupsList').innerHTML = `<p>Error loading groups: ${data.error}</p>`;
            }
        } catch (error) {
            console.error('Error loading groups:', error);
            document.getElementById('groupsList').innerHTML = `<p>Error loading groups.</p>`;
        }
    }

    async function createGroup() {
        const name = document.getElementById('groupName').value;
        const membersInput = document.getElementById('groupMembers').value;
        const members = membersInput.split(',').map(m => m.trim()).filter(m => m);

        if (!name || members.length === 0) {
            alert('Please fill in group name and at least one member.');
            return;
        }

        try {
            const response = await fetch('/create_group', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, members })
            });
            const data = await response.json();
            if (response.ok) {
                document.getElementById('groupName').value = '';
                document.getElementById('groupMembers').value = '';
                loadGroups();
                alert('Group created successfully.');
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred.');
        }
    }

    // --- Автообновление ---
    function startPolling() {
         if (pollInterval) clearInterval(pollInterval);
         pollInterval = setInterval(async () => {
             if (currentChatAddress) {
                 loadMessagesForConversation(currentChatAddress, true);
             }
         }, 3000);
    }

    function stopPolling() {
        if (pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
        }
    }

    // --- Инициализация ---
    document.addEventListener('DOMContentLoaded', function() {
        loadConversations();
        startPolling();

        const messageInput = document.getElementById('messageContent');
        messageInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });

        // Обработчики для модального окна
        document.getElementById('newChatBtn').onclick = openNewChatModal;
        document.querySelector('#newChatModal .close').onclick = closeNewChatModal;
        window.onclick = function(event) {
            const modal = document.getElementById('newChatModal');
            if (event.target == modal) {
                closeNewChatModal();
            }
        }
        document.getElementById('startNewChatBtn').onclick = startNewChat;
    });

    window.addEventListener('beforeunload', stopPolling);
</script>
{% endblock %}