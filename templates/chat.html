{% extends "base.html" %}
{% block content %}
<div class="chat-container">
    <div class="sidebar">
        <div class="user-info">
            <p>Your Address: <span id="userAddress">{{ address[:10] }}...</span></p>
            <button onclick="location.href='/logout'">Logout</button>
        </div>
        <nav>
            <ul>
                <li><a href="/chat" class="active">Chat</a></li>
                <li><a href="/contacts">Contacts</a></li>
                <li><a href="/groups">Groups</a></li>
                <li><a href="/profile">Profile</a></li>
            </ul>
        </nav>
        <div class="conversations-list">
            <div class="conversations-header">
                <h3>Conversations</h3>
                <button id="newChatBtn" class="header-btn" title="Start New Chat">+</button>
            </div>
            <ul id="conversationsList">
                <li class="conversation-item" data-address="" data-is-group="false">
                    <em>Select a conversation</em>
                </li>
            </ul>
        </div>
    </div>
    <div class="main-content">
        <div class="chat-header">
            Chat with: <span id="currentChatName">-</span>
            <button id="addToContactsBtn" class="header-btn" onclick="addContactFromChat()" disabled title="Add to Contacts">+</button>
            <button id="clearConversationBtn" class="header-btn" onclick="clearConversation()" disabled title="Clear Messages">&#x1F5D1;</button>

            <input type="hidden" id="currentChatAddress" value="">
            <input type="hidden" id="currentChatIsGroup" value="false">
            <input type="hidden" id="currentChatPartnerAddress" value="">
        </div>
        <div class="messages" id="messagesContainer">
            <p id="noChatSelectedMessage">Please select a conversation from the list.</p>
        </div>
        <div class="input-area">
            <input type="text" id="messageContent" placeholder="Type a message..." disabled>
            <button onclick="sendMessage()" id="sendButton" disabled>Send</button>
        </div>
    </div>
</div>

<!-- Модальное окно для нового чата -->
<div id="newChatModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Start New Chat</h2>
        <div class="modal-body">
            <div class="input-group">
                <label for="newChatSelect">Select Contact:</label>
                <select id="newChatSelect">
                    <option value="">-- Select a Contact --</option>
                    <!-- Опции будут загружены сюда -->
                </select>
            </div>
            <div class="input-group">
                <label for="newChatAddress">Or enter Address:</label>
                <input type="text" id="newChatAddress" placeholder="Enter full 64-character address">
            </div>
            <button id="startNewChatBtn">Start Chat</button>
        </div>
    </div>
</div>

<script>
    let currentChatAddress = "";
    let currentChatIsGroup = false;
    let currentChatPartnerAddress = "";
    let userAddress = "{{ address }}";
    let lastMessageTimestamp = 0;
    let pollInterval;
    let allContacts = []; // Глобальная переменная для хранения контактов

    // --- Функции для работы с диалогами ---

    async function loadConversations() {
        try {
            const response = await fetch('/get_conversations');
            const data = await response.json();
            if (response.ok) {
                const container = document.getElementById('conversationsList');
                container.innerHTML = '';
                if (data.conversations.length === 0) {
                    container.innerHTML = '<li><em>No conversations or contacts yet. Add some contacts!</em></li>';
                } else {
                    data.conversations.forEach(conv => {
                        const li = document.createElement('li');
                        li.className = 'conversation-item';
                        li.dataset.address = conv.address;
                        li.dataset.isGroup = conv.is_group;
                        const displayName = conv.name.length > 25 ? conv.name.substring(0, 22) + '...' : conv.name;
                        li.textContent = displayName;
                        li.onclick = () => selectConversation(conv.address, conv.name, conv.is_group);
                        container.appendChild(li);
                    });
                }
            } else {
                console.error('Failed to load conversations:', data.error);
            }
        } catch (error) {
            console.error('Error loading conversations:', error);
        }
    }

    function selectConversation(address, name, isGroup) {
        currentChatAddress = address;
        currentChatIsGroup = isGroup;
        currentChatPartnerAddress = isGroup ? "" : (address === userAddress ? "" : address);

        document.getElementById('currentChatAddress').value = address;
        document.getElementById('currentChatIsGroup').value = isGroup;
        document.getElementById('currentChatPartnerAddress').value = currentChatPartnerAddress;
        document.getElementById('currentChatName').textContent = name;

        document.querySelectorAll('.conversation-item').forEach(item => {
            item.classList.remove('active');
        });
        // Найти и активировать выбранный элемент
        const selectedItems = document.querySelectorAll(`.conversation-item[data-address="${address}"]`);
        if (selectedItems.length > 0) {
             selectedItems[0].classList.add('active');
        }

        document.getElementById('messageContent').disabled = false;
        document.getElementById('sendButton').disabled = false;
        document.getElementById('noChatSelectedMessage').style.display = 'none';

        const addToContactsBtn = document.getElementById('addToContactsBtn');
        const clearConversationBtn = document.getElementById('clearConversationBtn');
        if (isGroup || !currentChatPartnerAddress || currentChatPartnerAddress === userAddress) {
            addToContactsBtn.disabled = true;
            addToContactsBtn.title = "Cannot add group or yourself";
        } else {
            addToContactsBtn.disabled = false;
            addToContactsBtn.title = "Add to Contacts";
        }
        clearConversationBtn.disabled = false;
        clearConversationBtn.title = "Clear Messages";

        lastMessageTimestamp = 0;
        loadMessagesForConversation(address);
    }

     // --- Новая функция для загрузки контактов в модальное окно ---
    async function loadContactsForModal() {
        try {
            const response = await fetch('/get_contacts');
            const data = await response.json();
            if (response.ok) {
                allContacts = data.contacts; // Сохраняем для использования
                const selectElement = document.getElementById('newChatSelect');
                selectElement.innerHTML = '<option value="">-- Select a Contact --</option>';
                allContacts.forEach(contact => {
                    const option = document.createElement('option');
                    option.value = contact.address;
                    // Ограничиваем длину имени в списке
                    const displayName = contact.name.length > 30 ? contact.name.substring(0, 27) + '...' : contact.name;
                    option.textContent = `${displayName} (${contact.address.substring(0, 10)}...)`;
                    selectElement.appendChild(option);
                });
            } else {
                console.error('Failed to load contacts for modal:', data.error);
                alert('Could not load contacts. Please try again.');
            }
        } catch (error) {
            console.error('Error loading contacts for modal:', error);
            alert('An error occurred while loading contacts.');
        }
    }

    // --- Функции для работы с сообщениями ---

    async function loadMessagesForConversation(chatWithAddress, isNewMessage = false) {
        if (!chatWithAddress) {
             document.getElementById('messagesContainer').innerHTML = '<p id="noChatSelectedMessage">Please select a conversation.</p>';
             return;
        }
        try {
            const response = await fetch(`/get_conversation?with=${encodeURIComponent(chatWithAddress)}`);
            const data = await response.json();
            if (response.ok) {
                const container = document.getElementById('messagesContainer');
                const shouldScroll = isNewMessage || (container.scrollTop + container.clientHeight >= container.scrollHeight - 5);

                container.innerHTML = '';
                if (data.messages.length === 0) {
                    container.innerHTML = '<p><em>No messages yet. Start the conversation!</em></p>';
                } else {
                    let maxTimestamp = 0;
                    data.messages.forEach(msg => {
                        if (msg.timestamp > maxTimestamp) {
                            maxTimestamp = msg.timestamp;
                        }

                        const messageDiv = document.createElement('div');
                        messageDiv.className = `message ${msg.is_mine ? 'sent' : 'received'}`;
                        messageDiv.dataset.messageId = msg.id;

                        let imageHtml = '';
                        if (msg.image) {
                             if (msg.image.startsWith('data:image')) { // Inline base64
                                  imageHtml = `<img src="${msg.image}" alt="Image" style="max-width: 200px;">`;
                             } else { // URL to uploaded file
                                  imageHtml = `<img src="${msg.image}" alt="Image" style="max-width: 200px;">`;
                             }
                        }

                        const senderInfo = (msg.is_mine || !currentChatIsGroup) ? '' : `<strong>${msg.sender_name}</strong><br>`;

                        const deleteBtnHtml = msg.is_mine ?
                            `<button class="delete-message-btn" onclick="deleteMessage(${msg.id}, this)" title="Delete message">&#x1F5D9;</button>` :
                            '';

                        messageDiv.innerHTML = `
                            <div class="message-content-wrapper">
                                ${senderInfo}
                                <p>${msg.content}</p>
                                ${imageHtml}
                                <small>${new Date(msg.timestamp * 1000).toLocaleString()}</small>
                            </div>
                            ${deleteBtnHtml}
                        `;
                        container.appendChild(messageDiv);
                    });
                    lastMessageTimestamp = maxTimestamp;
                }

                if (shouldScroll) {
                    container.scrollTop = container.scrollHeight;
                }
            } else {
                console.error('Failed to load conversation:', data.error);
                if (!isNewMessage) {
                     document.getElementById('messagesContainer').innerHTML = `<p>Error loading messages: ${data.error}</p>`;
                }
            }
        } catch (error) {
            console.error('Error loading conversation:', error);
            if (!isNewMessage) {
                 document.getElementById('messagesContainer').innerHTML = `<p>Error loading messages.</p>`;
            }
        }
    }

    async function sendMessage() {
        const content = document.getElementById('messageContent').value.trim();
        const recipient = currentChatAddress;
        const isGroup = currentChatIsGroup === true || currentChatIsGroup === 'true';

        if (!recipient || !content) {
            alert('Please select a conversation and enter a message.');
            return;
        }

        const messageType = isGroup ? 'group' : 'direct';
        const groupId = isGroup ? recipient.split(':')[1] : null;

        const payload = {
            recipient: recipient,
            content: content,
            message_type: messageType
        };
        if (groupId) {
            payload.group_id = groupId;
        }

        try {
            const response = await fetch('/send_message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (response.ok) {
                document.getElementById('messageContent').value = '';
                loadMessagesForConversation(recipient, true);
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred.');
        }
    }

    // --- Новые функции ---

    async function addContactFromChat() {
        if (!currentChatPartnerAddress) {
            alert("Cannot add this conversation to contacts.");
            return;
        }

        const payload = {
            contact_address: currentChatPartnerAddress,
        };

        try {
            const response = await fetch('/add_contact_from_chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (response.ok) {
                alert(data.message);
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error adding contact:', error);
            alert('An error occurred while adding the contact.');
        }
    }

    async function deleteMessage(messageId, buttonElement) {
        if (!confirm("Are you sure you want to delete this message for yourself?")) {
            return;
        }

        try {
            buttonElement.disabled = true;
            buttonElement.textContent = '...';

            const response = await fetch('/delete_message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message_id: messageId })
            });
            const data = await response.json();
            if (response.ok) {
                buttonElement.closest('.message').remove();
                console.log(data.message);
            } else {
                alert('Error: ' + data.error);
                buttonElement.disabled = false;
                buttonElement.textContent = '&#x1F5D9;';
            }
        } catch (error) {
            console.error('Error deleting message:', error);
            alert('An error occurred while deleting the message.');
            buttonElement.disabled = false;
            buttonElement.textContent = '&#x1F5D9;';
        }
    }

    async function clearConversation() {
        if (!currentChatAddress) {
            alert("No conversation selected.");
            return;
        }

        if (!confirm("Clear all messages in this conversation for yourself?")) {
            return;
        }

        try {
            const response = await fetch('/clear_conversation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_with: currentChatAddress })
            });
            const data = await response.json();
            if (response.ok) {
                document.getElementById('messagesContainer').innerHTML = '<p><em>Conversation cleared.</em></p>';
                console.log(data.message);
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error clearing conversation:', error);
            alert('An error occurred while clearing the conversation.');
        }
    }

    // --- Логика нового чата ---
    function openNewChatModal() {
        document.getElementById('newChatModal').style.display = 'block';
        // Сбросить поля модального окна
        document.getElementById('newChatSelect').value = '';
        document.getElementById('newChatAddress').value = '';
        // Загрузить контакты при открытии
        loadContactsForModal();
    }

    function closeNewChatModal() {
        document.getElementById('newChatModal').style.display = 'none';
    }

    async function startNewChat() {
        const selectedAddress = document.getElementById('newChatSelect').value.trim();
        const enteredAddress = document.getElementById('newChatAddress').value.trim();

        let chatAddress = '';
        let chatName = '';

        if (selectedAddress) {
            chatAddress = selectedAddress;
            // Найти имя контакта
            const contact = allContacts.find(c => c.address === selectedAddress);
            chatName = contact ? contact.name : selectedAddress.substring(0, 10) + '...';
        } else if (enteredAddress) {
            if (enteredAddress.length !== 64) {
                alert('Please enter a valid 64-character address.');
                return;
            }
            if (enteredAddress === userAddress) {
                alert('You cannot start a chat with yourself.');
                return;
            }
            chatAddress = enteredAddress;
            chatName = enteredAddress.substring(0, 10) + '...';
        } else {
            alert('Please select a contact or enter an address.');
            return;
        }

        // Закрыть модальное окно
        closeNewChatModal();

        // Выбрать новый диалог (это создаст его в списке, если его там еще нет)
        selectConversation(chatAddress, chatName, false); // false = не группа
    }

    // --- Автообновление ---
    function startPolling() {
         if (pollInterval) clearInterval(pollInterval);
         pollInterval = setInterval(async () => {
             if (currentChatAddress) {
                 loadMessagesForConversation(currentChatAddress, true);
             }
         }, 3000);
    }

    function stopPolling() {
        if (pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
        }
    }

    // --- Инициализация ---
    document.addEventListener('DOMContentLoaded', function() {
        loadConversations();
        startPolling();

        const messageInput = document.getElementById('messageContent');
        messageInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });

        // Обработчики для модального окна
        document.getElementById('newChatBtn').onclick = openNewChatModal;
        document.querySelector('#newChatModal .close').onclick = closeNewChatModal;
        window.onclick = function(event) {
            const modal = document.getElementById('newChatModal');
            if (event.target == modal) {
                closeNewChatModal();
            }
        }
        document.getElementById('startNewChatBtn').onclick = startNewChat;
    });

    window.addEventListener('beforeunload', stopPolling);

</script>
{% endblock %}