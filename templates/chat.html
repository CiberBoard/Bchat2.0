<!-- templates/chat.html -->
{% extends "base.html" %}
{% block content %}
<div class="chat-container">
    <div class="sidebar">
        <div class="user-info">
            <p>Your Address: <span id="userAddress">{{ address[:10] }}...</span></p>
            <button onclick="location.href='/logout'">Logout</button>
        </div>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤ –≤–∏–¥–µ –≤–∫–ª–∞–¥–æ–∫ -->
        <div class="tabs">
            <div class="tab active" onclick="location.href='/chat'">Chat</div>
            <div class="tab" onclick="location.href='/contacts'">Contacts</div>
            <div class="tab" onclick="location.href='/groups'">Groups</div>
            <div class="tab" onclick="location.href='/profile'">Profile</div>
        </div>

        <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–æ–∫ -->
        <div id="chat-tab" class="tab-content active">
            <div class="conversations-header">
                <h3>Conversations</h3>
                <button id="newChatBtn" class="header-btn" title="Start New Chat">+</button>
            </div>
            <div class="conversations-list">
                <ul id="conversationsList">
                    <li class="conversation-item" data-address="" data-is-group="false">
                        <em>Select a conversation</em>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="chat-header">
            Chat with: <span id="currentChatName">-</span>
            <button id="addToContactsBtn" class="header-btn" onclick="addContactFromChat()" disabled title="Add to Contacts">+</button>
            <button id="clearConversationBtn" class="header-btn" onclick="clearConversation()" disabled title="Clear Messages">&#x1F5D1;</button>
        </div>
        <div class="messages" id="messagesContainer">
            <p id="noChatSelectedMessage">Please select a conversation.</p>
        </div>
        <div class="input-area">
            <input type="text" id="messageContent" placeholder="Type a message..." disabled>
            <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelection(event)">
            <button onclick="document.getElementById('imageInput').click()" id="attachImageButton" disabled title="Attach Image">&#x1F4F7;</button>
            <button onclick="sendMessage()" id="sendButton" disabled>Send</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞ -->
<div id="newChatModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Start New Chat</h2>
        <div class="modal-body">
            <!-- –ö–Ω–æ–ø–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR-–∫–æ–¥–∞ -->
            <div style="text-align: center; margin-bottom: 15px;">
                <button onclick="openQRScannerInModal()" id="scanQRBtn" class="scan-qr-btn-modal">
                    üì∑ Scan QR Code
                </button>
                <div id="qrScannerContainerModal" style="display: none; margin: 15px 0;">
                    <div style="position: relative;">
                        <video id="qrVideoModal" style="width: 100%; max-width: 250px; border: 2px solid #333; border-radius: 8px;"></video>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 200px; border: 2px solid #bb86fc; box-shadow: 0 0 0 1000px rgba(0,0,0,0.5);"></div>
                    </div>
                    <p style="color: #aaa; font-size: 12px; margin: 5px 0;">Point camera at QR code</p>
                    <button onclick="forceCloseQRScannerInModal()" style="margin-top: 10px; background-color: #cf6679; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; width: 100%;">Cancel Scan</button>
                </div>
                <div id="scanResultModal" style="margin-top: 10px; color: green; font-weight: bold; display: none;"></div>
            </div>

            <div class="input-group">
                <label for="newChatSelect">Select Contact:</label>
                <select id="newChatSelect">
                    <option value="">-- Select a Contact --</option>
                </select>
            </div>
            <div class="input-group">
                <label for="newChatAddress">Or enter Address:</label>
                <input type="text" id="newChatAddress" placeholder="Enter full 64-character address">
            </div>
            <button id="startNewChatBtn">Start Chat</button>
        </div>
    </div>
</div>

<style>
.status-active {
    color: #00c853;
    font-weight: bold;
}

.security-info {
    background-color: #2c2c2c;
    padding: 15px;
    border-radius: 4px;
    border-left: 3px solid #bb86fc;
}

.security-info p {
    margin: 8px 0;
    font-size: 14px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ */
.scan-qr-btn-modal {
    background-color: #bb86fc;
    color: #121212;
    border: none;
    padding: 12px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    width: 100%;
    margin-bottom: 15px;
}

.scan-qr-btn-modal:hover {
    background-color: #3700b3;
}

/* –£–ª—É—á—à–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è –æ–±–ª–∞—Å—Ç–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
#qrScannerContainerModal video {
    background-color: #000;
}

/* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∞—Ç—Ç–∞—á–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */
#attachImageButton {
    background: none;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 5px 10px;
    cursor: pointer;
    font-size: 16px;
    color: #ccc;
}
#attachImageButton:hover {
    color: #bb86fc;
    border-color: #bb86fc;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
    // –§—É–Ω–∫—Ü–∏–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    function copyToClipboard(elementId, feedbackId) {
        const element = document.getElementById(elementId);
        const feedback = document.getElementById(feedbackId);

        navigator.clipboard.writeText(element.value).then(() => {
            feedback.textContent = 'Copied!';
            feedback.style.color = 'green';
            setTimeout(() => { feedback.textContent = ''; }, 2000);
        }).catch(err => {
            console.error('Failed to copy: ', err);
            feedback.textContent = 'Failed to copy!';
            feedback.style.color = 'red';
        });
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è QR-—Å–∫–∞–Ω–µ—Ä–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    let scanIntervalModal = null;
    let streamModal = null;
    let isQRScannerActiveModal = false; // –§–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–∫–∞–Ω–µ—Ä–∞

    function openQRScannerInModal() {
        // –ï—Å–ª–∏ —Å–∫–∞–Ω–µ—Ä —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω, –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π
        if (isQRScannerActiveModal) {
            console.log('QR Scanner already active');
            return;
        }

        const scannerContainer = document.getElementById('qrScannerContainerModal');
        const video = document.getElementById('qrVideoModal');
        const scanBtn = document.getElementById('scanQRBtn');
        const scanResult = document.getElementById('scanResultModal');

        if (!scannerContainer || !video || !scanBtn || !scanResult) {
            console.error('QR Scanner elements not found');
            return;
        }

        isQRScannerActiveModal = true;
        scannerContainer.style.display = 'block';
        scanBtn.style.display = 'none';
        scanResult.style.display = 'none';
        scanResult.textContent = '';

        // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'environment',
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                }
            })
                .then(function(mediaStream) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∫–∞–Ω–µ—Ä –≤—Å–µ –µ—â–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–∫—Ç–∏–≤–µ–Ω
                    if (!isQRScannerActiveModal) {
                        mediaStream.getTracks().forEach(track => track.stop());
                        return;
                    }

                    streamModal = mediaStream;
                    video.srcObject = streamModal;

                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –≤–∏–¥–µ–æ
                    video.onloadedmetadata = function() {
                        if (isQRScannerActiveModal) {
                            video.play()
                                .then(() => {
                                    startScanningModal();
                                })
                                .catch(err => {
                                    console.error('Error playing video:', err);
                                    forceCloseQRScannerInModal();
                                });
                        }
                    };
                })
                .catch(function(err) {
                    console.error("Error accessing camera: ", err);
                    alert('Error accessing camera: ' + (err.message || 'Unknown error'));
                    forceCloseQRScannerInModal();
                });
        } else {
            alert('Camera access not supported in this browser.');
            forceCloseQRScannerInModal();
        }
    }

    function startScanningModal() {
        if (!isQRScannerActiveModal || scanIntervalModal) {
            return; // –£–∂–µ —Å–∫–∞–Ω–∏—Ä—É–µ–º –∏–ª–∏ —Å–∫–∞–Ω–µ—Ä –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω
        }

        const video = document.getElementById('qrVideoModal');
        const scanResult = document.getElementById('scanResultModal');

        if (!video || !scanResult) {
            console.error('Video or scan result elements not found');
            return;
        }

        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');

        scanIntervalModal = setInterval(function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∫–∞–Ω–µ—Ä –≤—Å–µ –µ—â–µ –∞–∫—Ç–∏–≤–µ–Ω
            if (!isQRScannerActiveModal) {
                stopScanningModal();
                return;
            }

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                try {
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);

                    if (code && code.data) {
                        let addressToSet = '';
                        let successMessage = '';

                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞–¥—Ä–µ—Å–æ–º (64 —Å–∏–º–≤–æ–ª–∞ hex)
                        if (code.data.length === 64 && /^[a-fA-F0-9]+$/.test(code.data)) {
                            addressToSet = code.data;
                            successMessage = 'Address scanned successfully!';
                        } else if (code.data.startsWith('bitcoin:') || code.data.startsWith('BITCOIN:')) {
                            // –û–±—Ä–∞–±–æ—Ç–∫–∞ Bitcoin URI
                            const addressMatch = code.data.match(/bitcoin:([a-zA-Z0-9]{26,})/);
                            if (addressMatch && addressMatch[1]) {
                                addressToSet = addressMatch[1];
                                successMessage = 'Bitcoin address extracted!';
                            }
                        }

                        if (addressToSet) {
                            // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                            stopScanningModal();

                            const addressInput = document.getElementById('newChatAddress');
                            if (addressInput) {
                                addressInput.value = addressToSet;
                            }

                            if (scanResult) {
                                scanResult.textContent = successMessage;
                                scanResult.style.display = 'block';
                                scanResult.style.color = 'green';
                            }

                            // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä –±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏
                            forceCloseQRScannerInModal();
                            return;
                        }
                    }
                } catch (e) {
                    console.log('QR scan attempt failed, continuing...', e);
                }
            }
        }, 300);
    }

    function stopScanningModal() {
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        if (scanIntervalModal) {
            clearInterval(scanIntervalModal);
            scanIntervalModal = null;
            console.log('QR scanning interval stopped');
        }
    }

    function forceCloseQRScannerInModal() {
        console.log('Force closing QR scanner...');

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        isQRScannerActiveModal = false;

        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        stopScanningModal();

        // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
        const scannerContainer = document.getElementById('qrScannerContainerModal');
        const scanBtn = document.getElementById('scanQRBtn');
        const video = document.getElementById('qrVideoModal');
        const scanResult = document.getElementById('scanResultModal');

        // –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        if (scannerContainer) {
            scannerContainer.style.display = 'none';
        }
        if (scanBtn) {
            scanBtn.style.display = 'block';
        }

        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–µ–æ –ø–æ—Ç–æ–∫
        if (streamModal) {
            try {
                const tracks = streamModal.getTracks();
                tracks.forEach(track => {
                    if (track.readyState === 'live') {
                        track.stop();
                        console.log('Track stopped:', track.kind);
                    }
                });
                streamModal = null;
                console.log('Media stream closed');
            } catch (e) {
                console.warn('Error stopping media stream:', e);
                streamModal = null;
            }
        }

        // –û—á–∏—â–∞–µ–º –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç
        if (video) {
            try {
                video.pause();
                video.srcObject = null;
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç
                video.load();
                console.log('Video element cleared');
            } catch (e) {
                console.warn('Error clearing video element:', e);
            }
        }

        // –û—á–∏—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
        if (scanResult) {
            setTimeout(() => {
                if (scanResult.style.display === 'block') {
                    scanResult.style.display = 'none';
                    scanResult.textContent = '';
                }
            }, 2000); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç 2 —Å–µ–∫—É–Ω–¥—ã, –∑–∞—Ç–µ–º —Å–∫—Ä—ã–≤–∞–µ–º
        }

        console.log('QR Scanner closed successfully');
    }


    // --- –õ–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ---
    let pendingImageData = null; // –•—Ä–∞–Ω–∏–º –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

    function handleImageSelection(event) {
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                // e.target.result —Å–æ–¥–µ—Ä–∂–∏—Ç Data URL (base64)
                pendingImageData = e.target.result; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                console.log("Image selected and encoded.");
                // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–≤—å—é
                // document.getElementById('messageContent').placeholder = "[Image Attached]";
            };
            reader.readAsDataURL(file); // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∫–∞–∫ Data URL (base64)
        } else {
             alert('Please select a valid image file.');
             pendingImageData = null;
        }
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º input, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤—ã–±—Ä–∞—Ç—å —Ç–æ—Ç –∂–µ —Ñ–∞–π–ª —Å–Ω–æ–≤–∞
        event.target.value = '';
    }

    // --- –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ JavaScript ---
    let currentChatAddress = "";
    let currentChatIsGroup = false;
    let currentChatPartnerAddress = "";
    let userAddress = "{{ address }}";
    let lastMessageTimestamp = 0;
    let pollInterval;
    let allContacts = [];

    // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∏–∞–ª–æ–≥–∞–º–∏ ---
    async function loadConversations() {
        try {
            const response = await fetch('/get_conversations');
            const data = await response.json();
            if (response.ok) {
                const container = document.getElementById('conversationsList');
                container.innerHTML = '';
                if (data.conversations.length === 0) {
                    container.innerHTML = '<li><em>No conversations. Add contacts!</em></li>';
                } else {
                    data.conversations.forEach(conv => {
                        const li = document.createElement('li');
                        li.className = 'conversation-item';
                        li.dataset.address = conv.address;
                        li.dataset.isGroup = conv.is_group;
                        const displayName = conv.name.length > 25 ? conv.name.substring(0, 22) + '...' : conv.name;
                        li.innerHTML = `
                            <div class="status-indicator"></div>
                            <div>${displayName}</div>
                        `;
                        li.onclick = () => selectConversation(conv.address, conv.name, conv.is_group);
                        container.appendChild(li);
                    });
                }
            } else {
                console.error('Failed to load conversations:', data.error);
            }
        } catch (error) {
            console.error('Error loading conversations:', error);
        }
    }

    function selectConversation(address, name, isGroup) {
        currentChatAddress = address;
        currentChatIsGroup = isGroup;
        currentChatPartnerAddress = isGroup ? "" : (address === userAddress ? "" : address);

        document.getElementById('currentChatName').textContent = name;

        document.querySelectorAll('.conversation-item').forEach(item => {
            item.classList.remove('active');
        });

        const selectedItems = document.querySelectorAll(`.conversation-item[data-address="${address}"]`);
        if (selectedItems.length > 0) {
             selectedItems[0].classList.add('active');
        }

        document.getElementById('messageContent').disabled = false;
        document.getElementById('attachImageButton').disabled = false; // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∞—Ç—Ç–∞—á–∞
        document.getElementById('sendButton').disabled = false;
        document.getElementById('noChatSelectedMessage').style.display = 'none';

        const addToContactsBtn = document.getElementById('addToContactsBtn');
        const clearConversationBtn = document.getElementById('clearConversationBtn');
        if (isGroup || !currentChatPartnerAddress || currentChatPartnerAddress === userAddress) {
            addToContactsBtn.disabled = true;
            addToContactsBtn.title = "Cannot add group or yourself";
        } else {
            addToContactsBtn.disabled = false;
            addToContactsBtn.title = "Add to Contacts";
        }
        clearConversationBtn.disabled = false;
        clearConversationBtn.title = "Clear Messages";

        lastMessageTimestamp = 0;
        loadMessagesForConversation(address);
        pendingImageData = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞
    }

    async function loadContactsForModal() {
        try {
            const response = await fetch('/get_contacts');
            const data = await response.json();
            if (response.ok) {
                allContacts = data.contacts;
                const selectElement = document.getElementById('newChatSelect');
                selectElement.innerHTML = '<option value="">-- Select a Contact --</option>';
                allContacts.forEach(contact => {
                    const option = document.createElement('option');
                    option.value = contact.address;
                    const displayName = contact.name.length > 30 ? contact.name.substring(0, 27) + '...' : contact.name;
                    option.textContent = `${displayName} (${contact.address.substring(0, 10)}...)`;
                    selectElement.appendChild(option);
                });
            } else {
                console.error('Failed to load contacts for modal:', data.error);
                alert('Could not load contacts.');
            }
        } catch (error) {
            console.error('Error loading contacts for modal:', error);
            alert('An error occurred while loading contacts.');
        }
    }

    async function loadMessagesForConversation(chatWithAddress, isNewMessage = false) {
        if (!chatWithAddress) {
             document.getElementById('messagesContainer').innerHTML = '<p id="noChatSelectedMessage">Please select a conversation.</p>';
             return;
        }
        try {
            const response = await fetch(`/get_conversation?with=${encodeURIComponent(chatWithAddress)}`);
            const data = await response.json();
            if (response.ok) {
                const container = document.getElementById('messagesContainer');
                const shouldScroll = isNewMessage || (container.scrollTop + container.clientHeight >= container.scrollHeight - 5);

                container.innerHTML = '';
                if (data.messages.length === 0) {
                    container.innerHTML = '<p><em>No messages yet.</em></p>';
                } else {
                    let maxTimestamp = 0;
                    data.messages.forEach(msg => {
                        if (msg.timestamp > maxTimestamp) {
                            maxTimestamp = msg.timestamp;
                        }

                        const messageDiv = document.createElement('div');
                        messageDiv.className = `message ${msg.is_mine ? 'sent' : 'received'}`;
                        messageDiv.dataset.messageId = msg.id;

                        let imageHtml = '';
                        if (msg.image) {
                             // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞ data:image
                             if (msg.image.startsWith('data:image')) {
                                  imageHtml = `<img src="${msg.image}" alt="Image" style="max-width: 200px; max-height: 200px; border-radius: 4px;">`;
                             } else {
                                  // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ data URL, –≤–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ –æ—à–∏–±–∫–∞ –∏–ª–∏ —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                                  // –ú–æ–∂–Ω–æ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å –∏–ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
                                  // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –ø–æ–ø—Ä–æ–±—É–µ–º –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å
                                  imageHtml = `<img src="${msg.image}" alt="Image" style="max-width: 200px; max-height: 200px; border-radius: 4px;">`;
                             }
                        }

                        const senderInfo = (msg.is_mine || !currentChatIsGroup) ? '' : `<strong>${msg.sender_name}</strong><br>`;

                        const deleteBtnHtml = msg.is_mine ?
                            `<button class="delete-message-btn" onclick="deleteMessage(${msg.id}, this)" title="Delete">&#x1F5D9;</button>` :
                            '';

                        messageDiv.innerHTML = `
                            <div class="message-content-wrapper">
                                ${senderInfo}
                                <p>${msg.content}</p>
                                ${imageHtml}
                                <small>${new Date(msg.timestamp * 1000).toLocaleString()}</small>
                            </div>
                            ${deleteBtnHtml}
                        `;
                        container.appendChild(messageDiv);
                    });
                    lastMessageTimestamp = maxTimestamp;
                }

                if (shouldScroll) {
                    container.scrollTop = container.scrollHeight;
                }
            } else {
                console.error('Failed to load conversation:', data.error);
                if (!isNewMessage) {
                     document.getElementById('messagesContainer').innerHTML = `<p>Error loading messages: ${data.error}</p>`;
                }
            }
        } catch (error) {
            console.error('Error loading conversation:', error);
            if (!isNewMessage) {
                 document.getElementById('messagesContainer').innerHTML = `<p>Error loading messages.</p>`;
            }
        }
    }

    async function sendMessage() {
        const content = document.getElementById('messageContent').value.trim();
        const recipient = currentChatAddress;
        const isGroup = currentChatIsGroup === true || currentChatIsGroup === 'true';

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–µ–∫—Å—Ç –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        if (!recipient || (!content && !pendingImageData)) {
            alert('Please enter a message or attach an image.');
            return;
        }

        const messageType = isGroup ? 'group' : 'direct';
        const groupId = isGroup ? recipient.split(':')[1] : null;

        const payload = {
            recipient: recipient,
            content: content || "", // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ –Ω–µ—Ç —Ç–µ–∫—Å—Ç–∞
            message_type: messageType
        };
        if (groupId) {
            payload.group_id = groupId;
        }
        // –ï—Å–ª–∏ –µ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤ payload
        if (pendingImageData) {
            payload.image = pendingImageData; // –ü–µ—Ä–µ–¥–∞–µ–º base64 —Å—Ç—Ä–æ–∫—É –Ω–∞–ø—Ä—è–º—É—é
        }

        try {
            const response = await fetch('/send_message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (response.ok) {
                document.getElementById('messageContent').value = '';
                pendingImageData = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
                loadMessagesForConversation(recipient, true);
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred.');
        }
    }

    async function addContactFromChat() {
        if (!currentChatPartnerAddress) {
            alert("Cannot add this conversation to contacts.");
            return;
        }

        const payload = {
            contact_address: currentChatPartnerAddress,
        };

        try {
            const response = await fetch('/add_contact_from_chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (response.ok) {
                alert(data.message);
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error adding contact:', error);
            alert('An error occurred while adding the contact.');
        }
    }

    async function deleteMessage(messageId, buttonElement) {
        if (!confirm("Delete this message for yourself?")) {
            return;
        }

        try {
            buttonElement.disabled = true;
            buttonElement.textContent = '...';

            const response = await fetch('/delete_message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message_id: messageId })
            });
            const data = await response.json();
            if (response.ok) {
                buttonElement.closest('.message').remove();
                console.log(data.message);
            } else {
                alert('Error: ' + data.error);
                buttonElement.disabled = false;
                buttonElement.textContent = '&#x1F5D9;';
            }
        } catch (error) {
            console.error('Error deleting message:', error);
            alert('An error occurred while deleting the message.');
            buttonElement.disabled = false;
            buttonElement.textContent = '&#x1F5D9;';
        }
    }

    async function clearConversation() {
        if (!currentChatAddress) {
            alert("No conversation selected.");
            return;
        }

        if (!confirm("Clear all messages in this conversation?")) {
            return;
        }

        try {
            const response = await fetch('/clear_conversation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_with: currentChatAddress })
            });
            const data = await response.json();
            if (response.ok) {
                document.getElementById('messagesContainer').innerHTML = '<p><em>Conversation cleared.</em></p>';
                console.log(data.message);
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error clearing conversation:', error);
            alert('An error occurred while clearing the conversation.');
        }
    }

    // --- –õ–æ–≥–∏–∫–∞ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞ ---
    function openNewChatModal() {
        const modal = document.getElementById('newChatModal');
        if (modal) {
            modal.style.display = 'block';
        }

        const selectElement = document.getElementById('newChatSelect');
        const addressInput = document.getElementById('newChatAddress');
        if (selectElement) selectElement.value = '';
        if (addressInput) addressInput.value = '';

        loadContactsForModal();
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        forceCloseQRScannerInModal();
    }

    function closeNewChatModal() {
        const modal = document.getElementById('newChatModal');
        if (modal) {
            modal.style.display = 'none';
        }
        // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        forceCloseQRScannerInModal();
    }

    async function startNewChat() {
        const selectedAddress = document.getElementById('newChatSelect')?.value.trim() || '';
        const enteredAddress = document.getElementById('newChatAddress')?.value.trim() || '';

        let chatAddress = '';
        let chatName = '';

        if (selectedAddress) {
            chatAddress = selectedAddress;
            const contact = allContacts.find(c => c.address === selectedAddress);
            chatName = contact ? contact.name : selectedAddress.substring(0, 10) + '...';
        } else if (enteredAddress) {
            if (enteredAddress.length !== 64) {
                alert('Please enter a valid 64-character address.');
                return;
            }
            if (enteredAddress === userAddress) {
                alert('You cannot start a chat with yourself.');
                return;
            }
            chatAddress = enteredAddress;
            chatName = enteredAddress.substring(0, 10) + '...';
        } else {
            alert('Please select a contact or enter an address.');
            return;
        }

        closeNewChatModal();
        selectConversation(chatAddress, chatName, false);
    }

    // --- –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ ---
    function startPolling() {
         if (pollInterval) clearInterval(pollInterval);
         pollInterval = setInterval(async () => {
             if (currentChatAddress) {
                 loadMessagesForConversation(currentChatAddress, true);
             }
         }, 3000);
    }

    function stopPolling() {
        if (pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
        }
    }

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    document.addEventListener('DOMContentLoaded', function() {
        loadConversations();
        startPolling();

        const messageInput = document.getElementById('messageContent');
        if (messageInput) {
            messageInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        const newChatBtn = document.getElementById('newChatBtn');
        const closeModalBtn = document.querySelector('#newChatModal .close');
        const startNewChatBtn = document.getElementById('startNewChatBtn');

        if (newChatBtn) newChatBtn.onclick = openNewChatModal;
        if (closeModalBtn) closeModalBtn.onclick = closeNewChatModal;
        if (startNewChatBtn) startNewChatBtn.onclick = startNewChat;

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        window.onclick = function(event) {
            const modal = document.getElementById('newChatModal');
            if (event.target == modal) {
                closeNewChatModal();
            }
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞/–≤–∫–ª–∞–¥–∫–∏
    window.addEventListener('beforeunload', function() {
        forceCloseQRScannerInModal();
        stopPolling();
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è —Å–∫–∞–Ω–µ—Ä–∞ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Escape
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const modal = document.getElementById('newChatModal');
            if (modal && modal.style.display === 'block') {
                closeNewChatModal();
            }
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã - –∑–∞–∫—Ä—ã–≤–∞–µ–º –∫–∞–º–µ—Ä—É –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–æ–∫
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            // –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–∫—Ä—ã—Ç–∞ - –∑–∞–∫—Ä—ã–≤–∞–µ–º –∫–∞–º–µ—Ä—É
            forceCloseQRScannerInModal();
        }
    });
</script>
{% endblock %}