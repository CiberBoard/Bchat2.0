{% extends "base.html" %}
{% block content %}
<div class="chat-container">
    <div class="sidebar">
        <div class="user-info">
            <p>Your Address: <span id="userAddress">{{ address[:10] }}...</span></p>
            <button onclick="location.href='/logout'">Logout</button>
        </div>
        <nav>
            <ul>
                <li><a href="/chat" {% if request.endpoint == 'chat' %}class="active"{% endif %}>Chat</a></li>
                <li><a href="/contacts" {% if request.endpoint == 'contacts' %}class="active"{% endif %}>Contacts</a></li>
                <li><a href="/groups" {% if request.endpoint == 'groups' %}class="active"{% endif %}>Groups</a></li>
                <li><a href="/profile" {% if request.endpoint == 'profile' %}class="active"{% endif %}>Profile</a></li>
            </ul>
        </nav>
    </div>
    <div class="main-content">
        <h2>Groups</h2>
        <div class="groups-list" id="groupsList">
            <!-- Groups will be loaded here -->
        </div>
        <div class="input-area">
            <input type="text" id="groupName" placeholder="Group Name">
            <input type="text" id="groupMembers" placeholder="Member Addresses (comma separated)">
            <button onclick="createGroup()">Create Group</button>
        </div>
    </div>
</div>

<script>
    async function loadGroups() {
        try {
            const response = await fetch('/get_groups');
            const data = await response.json();
            if (response.ok) {
                const container = document.getElementById('groupsList');
                container.innerHTML = '<ul>';
                if (data.groups.length === 0) {
                    container.innerHTML += '<li>No groups found.</li>';
                } else {
                    data.groups.forEach(group => {
                        container.innerHTML += `<li>${group.name} (ID: ${group.id.substring(0, 10)}...)</li>`;
                    });
                }
                container.innerHTML += '</ul>';
            } else {
                console.error('Failed to load groups:', data.error);
                document.getElementById('groupsList').innerHTML = `<p>Error loading groups: ${data.error}</p>`;
            }
        } catch (error) {
            console.error('Error loading groups:', error);
            document.getElementById('groupsList').innerHTML = `<p>Error loading groups.</p>`;
        }
    }

    async function createGroup() {
        const name = document.getElementById('groupName').value;
        const membersInput = document.getElementById('groupMembers').value;
        const members = membersInput.split(',').map(m => m.trim()).filter(m => m);

        if (!name || members.length === 0) {
            alert('Please fill in group name and at least one member.');
            return;
        }

        try {
            const response = await fetch('/create_group', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, members })
            });
            const data = await response.json();
            if (response.ok) {
                document.getElementById('groupName').value = '';
                document.getElementById('groupMembers').value = '';
                loadGroups(); // Перезагрузить группы
                alert('Group created successfully.');
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred.');
        }
    }

    // Загрузка групп при открытии страницы
    loadGroups();
</script>
{% endblock %}